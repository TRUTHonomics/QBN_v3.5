services:
  # 1. Inference Container (Real-time Predictions)
  # REASON: Alleen voor real-time inference, minimale footprint
  qbn:
    build:
      context: .
      dockerfile: Dockerfile
    image: qbn:latest
    container_name: QBN_v4_Inference
    restart: unless-stopped
    
    # REASON: IPC host mode voor CUDA multiprocessing support
    ipc: host
    shm_size: '16gb'  # Shared memory voor multiprocessing
    
    # Environment variables laden
    env_file:
      - .env.local
    
    # GPU ondersteuning
    runtime: nvidia
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # REASON: Voorkom CUDA multiprocessing errors in Docker
      - CUDA_LAUNCH_BLOCKING=0
      - CUPY_CACHE_IN_MEMORY=1
      # PyTorch CUDA settings
      - TORCH_CUDA_ARCH_LIST=8.9  # Ada Lovelace (RTX 40xx/50xx)
      # Real-time settings
      - START_INFERENCE_LOOP=true
      - QBN_ROLE=inference
    
    # Volumes voor development
    # REASON: kfl_backend_config is nu lokaal in ./kfl_backend_config (geen Samba mount meer)
    volumes:
      - .:/app
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # REASON: Toegang tot docker socket voor orchestratie van andere containers (KFL GPU)
      - /var/run/docker.sock:/var/run/docker.sock
    
    # Network configuratie
    networks:
      - qbn-network
    
    # PostgreSQL server toevoegen aan hosts
    extra_hosts:
      - "postgres-server:10.10.10.3"
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 75G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    # Port mapping voor FastAPI
    ports:
      - "8082:8081"
    
    # Logging configuratie
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    
    # Interactive terminal
    stdin_open: true
    tty: true

  # 2. Training Container (CPT Generation, Alpha Analysis, Threshold Optimization)
  # REASON: Alle model training en data preparatie taken
  qbn-training:
    image: qbn:latest  # Hergebruikt dezelfde image
    container_name: QBN_v4_Training
    restart: "no"  # Draait alleen on-demand
    
    ipc: host
    shm_size: '16gb'
    
    env_file:
      - .env.local
    
    runtime: nvidia
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_LAUNCH_BLOCKING=0
      - CUPY_CACHE_IN_MEMORY=1
      - TORCH_CUDA_ARCH_LIST=8.9
      # Training settings
      - START_INFERENCE_LOOP=false
      - QBN_ROLE=training
    
    volumes:
      - .:/app
      # REASON: Toegang tot docker socket voor orchestratie van andere containers (KFL GPU)
      - /var/run/docker.sock:/var/run/docker.sock
    
    networks:
      - qbn-network
    
    extra_hosts:
      - "postgres-server:10.10.10.3"
    
    deploy:
      resources:
        limits:
          memory: 75G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    stdin_open: true
    tty: true
    # Standaard commando opent interactive menu
    command: /bin/bash

  # 3. Validation Container (Walk-Forward, Backtesting, Quality Checks)
  # REASON: Model validatie en quality assurance
  qbn-validation:
    image: qbn:latest  # Hergebruikt dezelfde image
    container_name: QBN_v4_Validation
    restart: "no"  # Draait alleen on-demand
    
    ipc: host
    shm_size: '16gb'
    
    env_file:
      - .env.local
    
    runtime: nvidia
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_LAUNCH_BLOCKING=0
      - CUPY_CACHE_IN_MEMORY=1
      - TORCH_CUDA_ARCH_LIST=8.9
      # Validation settings
      - START_INFERENCE_LOOP=false
      - QBN_ROLE=validation
    
    volumes:
      - .:/app
      # REASON: Toegang tot docker socket voor orchestratie van andere containers (KFL GPU)
      - /var/run/docker.sock:/var/run/docker.sock
    
    networks:
      - qbn-network
    
    extra_hosts:
      - "postgres-server:10.10.10.3"
    
    deploy:
      resources:
        limits:
          memory: 75G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    stdin_open: true
    tty: true
    # Standaard commando opent interactive menu
    command: /bin/bash

  # 4. Dagster Webserver (UI + Asset Graph)
  # REASON: Orkestratie-dashboard voor training/inference/validation (Fase 1: dummy assets)
  dagster-webserver:
    image: qbn:latest
    container_name: QBN_v4_Dagster_Webserver
    restart: unless-stopped

    env_file:
      - .env.local
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - DAGSTER_HOME=/app/dagster_home
      # REASON: Dagster container mag geen inference loop starten
      - START_INFERENCE_LOOP=false
      - QBN_ROLE=dagster

    volumes:
      - .:/app
      - ../KFL_backend_GPU_v6:/app_kfl:ro

    networks:
      - qbn-network

    extra_hosts:
      - "postgres-server:10.10.10.3"

    ports:
      - "3005:3000"

    command: dagster-webserver -h 0.0.0.0 -p 3000 -w /app/dagster_home/workspace.yaml

  # 5. Dagster Daemon (schedules/sensors)
  dagster-daemon:
    image: qbn:latest
    container_name: QBN_v4_Dagster_Daemon
    restart: unless-stopped

    env_file:
      - .env.local
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - DAGSTER_HOME=/app/dagster_home
      - START_INFERENCE_LOOP=false
      - QBN_ROLE=dagster

    volumes:
      - .:/app
      - ../KFL_backend_GPU_v6:/app_kfl:ro
      # REASON: Dagster daemon heeft docker socket nodig voor docker exec naar training container
      - /var/run/docker.sock:/var/run/docker.sock

    networks:
      - qbn-network

    extra_hosts:
      - "postgres-server:10.10.10.3"

    depends_on:
      - dagster-webserver

    command: dagster-daemon run -w /app/dagster_home/workspace.yaml

networks:
  qbn-network:
    driver: bridge
